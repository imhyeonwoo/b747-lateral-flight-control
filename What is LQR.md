# LQR (Linear Quadratic Regulator) 정리

## 1. LQR의 목적과 문제 설정

B-747 횡방향(lateral) 선형 모델을

$$\dot{x}=Ax+Bu$$

로 두고, 시간에 따라 변하는 입력 $u(t)$를 어떻게 주면 “상태가 빨리 안정화(진동 억제 + 불안정 모드 안정화)”되면서도 “입력 에너지를 과도하게 쓰지 않도록” 만들 수 있을지의 **최적 제어 문제**로 정리한다.

LQR은 이를 다음 비용함수(cost function)를 최소화하는 문제로 둔다.

$$J=\int_0^{\infty}\left(x^TQx+u^TRu\right)\,dt$$

- $Q \succeq 0$: 상태 오차(또는 상태 크기)에 대한 가중치  
- $R \succ 0$: 입력 사용량(에너지)에 대한 가중치

즉, $Q$는 “어떤 상태를 더 강하게 억제할 것인가”, $R$은 “제어 입력을 얼마나 아낄 것인가”를 설계자가 정하는 기준이다.

---

## 2. 왜 2차(Quadratic) 비용함수인가?

- 상태 및 입력의 **에너지(크기)**를 벌점으로 주기 좋다: $x^TQx$, $u^TRu$는 각 성분의 제곱합(가중 합) 형태.
- 2차 함수는 **볼록**(convex)이어서 전역 최적해가 보장되기 쉽다.
- 변분법으로 최적화를 풀면, 선형 시스템에서 자연스럽게 **선형 상태피드백** 형태의 최적 제어법칙이 유도된다.

---

## 3. 최적 제어법칙: 상태 피드백 $u=-Kx$

LQR의 해는 다음과 같은 형태로 나온다.

$$u(t)=-Kx(t)$$

여기서 $K$는 **피드백 이득 행렬**(Feedback Gain Matrix)이며, $K$는 다음 대수적 리카티 방정식(ARE)의 해 $P$로부터 계산된다.

### (1) Algebraic Riccati Equation (ARE)

$$A^TP+PA-PBR^{-1}B^TP+Q=0$$

### (2) 최적 이득 $K$

$$K=R^{-1}B^TP$$

정리하면, 설계자는 $Q, R$만 정하면 되고, 그 뒤의 $P, K$는 수학적으로 자동 산출된다.

---

## 4. 가중치 행렬 $Q, R$ 튜닝 감각

LQR 튜닝은 사실상 **$Q$와 $R$의 상대적 크기 조정**이다.

- $Q$를 크게: 상태를 더 강하게 0으로 끌어오려 함(더 공격적/빠른 안정화)
- $R$을 크게: 입력을 아끼려 함(더 보수적/완만한 제어)

보고서의 예시 튜닝(상태/입력 정의 기준):
- 상태: $x=[\beta,\ r,\ p,\ \phi]^T$  
- 입력: $u=[\delta_r,\ \delta_a]^T$

예시로 아래처럼 $r$(yaw rate)와 $\phi$(bank angle)에 큰 가중을 둔다.

```matlab
% x = [beta, r, p, phi]
q_beta = 1;
q_r    = 100;  % Dutch roll 억제 핵심
q_p    = 1;
q_phi  = 100;  % 자세 유지/추종 핵심
Q = diag([q_beta, q_r, q_p, q_phi]);

% u = [delta_r, delta_a]
r_rudder  = 10;
r_aileron = 10;
R = diag([r_rudder, r_aileron]);

[K_lqr, S, E] = lqr(A, B, Q, R);
```

---

## 5. Simulink 구현 포인트 (State Feedback Regulator)

프로젝트의 목표는
- 불필요한 진동 억제(Active Damping)
- 불안정 모드 안정화(Stabilization)

를 핵심 목표로 삼아 **Regulator 구조**로 구성한다.

따라서 **Feedforward 게인**이나 **적분기(Integrator)**는 배제하고,
상태를 평형점으로 수렴시키는 **Full-State Feedback**을 전제로 구현한다.

### Full-state feedback를 위한 출력 설정

LQR은 모든 상태를 피드백해야 하므로, Simulink에서 플랜트의 출력이 상태 $x$ 자체가 되도록 다음과 같이 설정한다.

- 기존 출력행렬 $C$ 대신

$$C=\mathrm{eye}(4)$$

를 적용해 $x=[\beta,\ r,\ p,\ \phi]^T$가 그대로 나오게 구성한다.

---

## 6. 성능 비교 요약 (Open-loop vs Wash-out vs LQR)

비교 분석 요지를 정리하면:

### Step 입력(외란이 지속되는 상황)

- Open-loop / Wash-out: 입력이 지속되거나 종료된 뒤에도 불안정/잔류 거동이 남을 수 있음
- **LQR**: 모든 상태를 피드백하여 스파이럴 모드 등 불안정 극점을 안정 영역으로 이동시켜,
  외란이 “지속되는 상황에서도” 요 레이트를 0 근처(평형점)에 안정적으로 유지하는 레귤레이터 성능을 보임

### Doublet 입력(더치 롤 유발, 감쇠 성능 평가)

- Open-loop: 입력 종료 후에도 감쇠비가 낮아 진동이 오래 지속
- Wash-out: 감쇠가 빨라지지만 잔류 진동이 관찰
- **LQR**: 입력 종료 직후 잔류 진동을 거의 즉시 0으로 소멸시키는 수준의 강한 감쇠 성능  
  → 감쇠비를 크게 높여 Ride Quality와 안정성 개선 가능성을 시사

---

## 7. 정리 한 줄

LQR은 $Q$와 $R$로 “상태 안정화 vs 입력 에너지”의 균형을 설계자가 정하면,
$$ u=-Kx $$
형태의 최적 상태피드백을 리카티 방정식으로 자동 산출해
복잡한 주파수영역 설계 없이도 강력한 안정화/감쇠 성능을 얻는 현대 제어 기법이다.
